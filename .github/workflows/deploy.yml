name: Deploy vmkotov_test_bot

on:
  push:
    branches: [ main ]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'Dockerfile.yc'
      - '.github/workflows/deploy.yml'

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    outputs:
      secrets-exist: ${{ steps.check.outputs.secrets-exist }}
    steps:
      - name: Check if secrets are configured
        id: check
        run: |
          if [[ -z "${{ secrets.YC_IAM_KEY_JSON }}" ]] || \
             [[ -z "${{ secrets.YC_CLOUD_ID }}" ]] || \
             [[ -z "${{ secrets.YC_FOLDER_ID }}" ]] || \
             [[ -z "${{ secrets.YC_SERVICE_ACCOUNT_ID }}" ]] || \
             [[ -z "${{ secrets.YC_REGISTRY_ID }}" ]] || \
             [[ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]]; then
            echo "⚠️  Some secrets are missing. Skipping deployment."
            echo "secrets-exist=false" >> $GITHUB_OUTPUT
          else
            echo "✅ All required secrets are configured."
            echo "secrets-exist=true" >> $GITHUB_OUTPUT
          fi
  
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: check-secrets
    if: needs.check-secrets.outputs.secrets-exist == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Install dependencies
      run: go mod download
      
    - name: Test build
      run: go build -o bot . && echo "Build successful"
      
    - name: Setup Yandex Cloud CLI
      run: |
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i ~/.local -n
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        sleep 2
        yc --version
      
    - name: Configure Yandex Cloud with IAM Key
      run: |
        # Создаем файл с IAM ключом из секрета
        echo '${{ secrets.YC_IAM_KEY_JSON }}' > /tmp/iam-key.json
        
        # Настраиваем yc с IAM ключом
        yc config set service-account-key /tmp/iam-key.json
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        
        # Проверяем что авторизация работает
        echo "Testing authentication..."
        yc iam service-account get ${{ secrets.YC_SERVICE_ACCOUNT_ID }} --format json | jq -r '.name'
        
    - name: Login to Container Registry
      run: |
        # Получаем IAM токен для Docker
        IAM_TOKEN=$(yc iam create-token)
        echo $IAM_TOKEN | docker login \
          --username iam \
          --password-stdin \
          cr.yandex
          
    - name: Build Docker image
      run: |
        docker build \
          -t cr.yandex/${{ secrets.YC_REGISTRY_ID }}/vmkotov-test-bot:latest \
          -t cr.yandex/${{ secrets.YC_REGISTRY_ID }}/vmkotov-test-bot:${{ github.sha }} \
          -f Dockerfile.yc .
          
    - name: Push Docker image
      run: |
        docker push cr.yandex/${{ secrets.YC_REGISTRY_ID }}/vmkotov-test-bot:latest
        docker push cr.yandex/${{ secrets.YC_REGISTRY_ID }}/vmkotov-test-bot:${{ github.sha }}
        
    - name: Deploy to Yandex Cloud
      run: |
        # Создаем переменные окружения
        ENV_VARS="TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }},PORT=8080"
        
        # Добавляем дополнительные переменные если есть
        if [ -n "${{ secrets.ADMIN_CHAT_ID }}" ]; then
          ENV_VARS="$ENV_VARS,ADMIN_CHAT_ID=${{ secrets.ADMIN_CHAT_ID }}"
        fi
        
        if [ -n "${{ secrets.DEBUG }}" ]; then
          ENV_VARS="$ENV_VARS,DEBUG=${{ secrets.DEBUG }}"
        fi
        
        if [ -n "${{ secrets.LOG_LEVEL }}" ]; then
          ENV_VARS="$ENV_VARS,LOG_LEVEL=${{ secrets.LOG_LEVEL }}"
        fi
        
        if [ -n "${{ secrets.DATABASE_URL }}" ]; then
          ENV_VARS="$ENV_VARS,DATABASE_URL=${{ secrets.DATABASE_URL }}"
        fi
        
        # Деплоим
        yc serverless container revision deploy \
          --container-name vmkotov-test-bot \
          --image cr.yandex/${{ secrets.YC_REGISTRY_ID }}/vmkotov-test-bot:${{ github.sha }} \
          --cores 1 \
          --memory 128MB \
          --concurrency 1 \
          --execution-timeout 300s \
          --service-account-id ${{ secrets.YC_SERVICE_ACCOUNT_ID }} \
          --environment "$ENV_VARS" \
          --description "Auto-deploy from GitHub: ${{ github.sha }}"
          
    - name: Verify deployment
      run: |
        sleep 5
        echo "Deployment complete!"
        yc serverless container revision list --container-name vmkotov-test-bot --limit 1
  
  skip-deploy:
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.secrets-exist == 'false'
    steps:
      - name: Skip deployment
        run: |
          echo "⏭️  Skipping deployment because not all required secrets are configured."
          echo "Please add the following secrets to GitHub repository settings:"
          echo "1. YC_IAM_KEY_JSON"
          echo "2. YC_CLOUD_ID"
          echo "3. YC_FOLDER_ID"
          echo "4. YC_SERVICE_ACCOUNT_ID"
          echo "5. YC_REGISTRY_ID"
          echo "6. TELEGRAM_BOT_TOKEN"
          echo ""
          echo "Go to: Settings → Secrets and variables → Actions"
